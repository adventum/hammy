{%set N = 10 -%}
insert into function s3(
  's3:///hammy/lagrangian/1/1/proc/exactness-curve.csv',
  'CSVWithNames'
) with  
sorted as (select checkpoint10_position,
  {%- set comma = joiner(",") %}
  {%- for i in range(1, N + 1) %}{{ comma() }}
  row_number() over(order by rand()) sorted{{ i }}
  {%- endfor %}
  from s3('s3:///hammy/lagrangian/1/1/raw/*.gzip.parquet', Parquet)  --file('hammy/lagrangian_*.snappy.parquet', Parquet) 
  where target_position = 60),

counts as (select *,
  {%- set comma = joiner(",") %}
  {%- for i in range(1, N + 1) %}{{ comma() }}
  countIf(checkpoint10_position = 10) over(order by sorted1) position{{ i }}_exact, 
  countIf(checkpoint10_position = 8) over(order by sorted1) position{{ i }}_left,
  countIf(checkpoint10_position = 12) over(order by sorted1) position{{ i }}_right
  {%- endfor %}
  from sorted),
is_top_exact as (select
  {%- set comma = joiner(",") %}
  {%- for i in range(1, N + 1) %}{{ comma() }}
  sorted{{ i }},
  position{{ i }}_exact > position{{ i }}_left and position{{ i }}_exact > position{{ i }}_right correct{{ i }}
  {%- endfor %}
  from counts),
fix_changes as (select
  {%- set comma = joiner(",") %}
  {%- for i in range(1, N + 1) %}{{ comma() }}
  sorted{{ i }},
  correct{{ i }} - lagInFrame(correct{{ i }}) over (order by sorted{{ i }}) as change{{ i }}
  {%- endfor %}
  from is_top_exact),
leave_changes as (select *
  from fix_changes
  where {%- set orr = joiner(" or ") %}
    {% for i in range(1, N + 1) %}{{ orr() }}change{{ i }}{% endfor %}),
union_changes as (
  {%- set union_all = joiner(" union all ") %}
  {%- for i in range(1, N + 1) %}{{ union_all() }}select sorted{{ i }} sorted, change{{ i }} change
    from leave_changes where change{{ i }} != 0
  {%- endfor %}),
accumulate_changes as (select sorted, 
  cast(sum(change) over (order by sorted) as Float32) / {{ N }} as exactness_ratio
  from union_changes)
select * from accumulate_changes
settings s3_create_new_file_on_insert=1
